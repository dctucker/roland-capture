#include <math.h>
#include "lib/memory.h"
#include "test.h"

bool test_addr_coord(capmix_coord_t expected, capmix_addr_t addr)
{
	capmix_coord_t coord = capmix_addr_coord(addr);
	printf("0x%08x -> { section = 0x%x, offset = 0x%x }", addr, coord.section, coord.offset);
	return coord.section == expected.section
		&& coord.offset  == expected.offset;
}

bool test_readback( char *data, int len, capmix_addr_t addr )
{
	bool ret = 1;
	int      actual_len  = capmix_memory_set( addr, data, len );
	uint8_t *actual_data = capmix_memory_get( addr );

	printf("len=%d, data=", actual_len);
	for(int i=0; i < actual_len; i++) printf("0x%02x ", actual_data[i]);
	printf(" expected len=%d", len);

	if( actual_len != len )
		ret = 0;
	else
	{
		printf(", data=");
		for(int i=0; i < len; i++)
		{
			printf("0x%02x ", data[i]);
			ret = ret && data[i] == actual_data[i];
		}
	}
	return ret;
}

#define COORD(SEC,OFF) (capmix_coord_t){.section=SEC,.offset=OFF}
int main(int argc, char *argv[])
{
	bool b;
	printf("\nTesting memory...\n");

	TEST( test_addr_coord(COORD(0x6, 0x24e), 0x0006120e) );
	TEST( test_addr_coord(COORD(0x5, 0x0e7), 0x00050707) );
	TEST( test_addr_coord(COORD(0xa, 0x101), 0x000a0101) );

	char data[] = { 0x20, 0x7f, 0x7f, 0x7f };
	TEST( test_readback( data, 4, 0x00060004) );
	TEST( test_readback( data, 4, 0x00061104) );

	char msg1[] = { 0,0x11,0x00,0x02,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x46,0x17,0x00,0x00,0x7f,0x7f,0x7f,0x7f,0x00,0x00,0x00,0x00,0x7f,0x7f,0x7f,0x7f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 };
	//char msg1[] = { 0,0x03,0x00,0x02,0x00,0x00,0x00,0x00,0x0b,0x5a,0x0b,0x10,0x00,0x01,0x00,0x01,0x00,0x02,0x00,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1a,0x50,0x19,0x2b,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x4d,0x75,0x4d,0x75,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x00,0x00,0x00,0x00,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f};
	char msg2[] = { 0,0,0,0,0,0,0,0 };
	TEST( test_readback( msg1, 124, 0x000a0001) );
	TEST( test_readback( msg2, 8, 0x000a0101) );

	DONE;
}
